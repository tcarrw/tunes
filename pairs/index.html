<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tunes — Pairs</title>
  <meta name="color-scheme" content="light dark"/>
  <style>
    :root{
      --bg:#0b0f14;
      --surface:#111827;
      --surface-2:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --border:#1f2737;
      --accent:#7c3aed;
      --accent-ink:#ffffff;
      --shadow:0 8px 24px rgba(0,0,0,.28);
      --radius:12px;
      --radius-sm:10px;
      --radius-xs:8px;
      --ring:0 0 0 2px color-mix(in oklab, var(--accent) 30%, transparent);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7fafc;
        --surface:#ffffff;
        --surface-2:#f8fafc;
        --text:#0f172a;
        --muted:#475569;
        --border:#e2e8f0;
        --accent:#6d28d9;
        --accent-ink:#ffffff;
        --shadow:0 8px 20px rgba(17,24,39,.08);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% -10%, color-mix(in oklab, var(--accent) 16%, transparent), transparent), var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .shell{max-width:1100px; margin:24px auto 56px; padding:0 16px}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      background:linear-gradient(180deg, color-mix(in oklab, var(--surface) 94%, transparent), var(--surface));
      border:1px solid var(--border); border-radius:var(--radius); padding:18px 20px; box-shadow:var(--shadow);
      position:sticky; top:12px; z-index:5; backdrop-filter:saturate(1.2) blur(6px)
    }
    .brand{display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.2px}
    .glyph{display:inline-grid; place-items:center; width:32px; height:32px; border-radius:8px; background:var(--accent); color:var(--accent-ink); font-size:18px}
    .brand h1{font-size:18px; margin:0}
    .controls{display:flex; flex-wrap:wrap; align-items:center; gap:10px}
    .btn{
      border:1px solid var(--border); background:var(--surface-2); color:var(--text);
      padding:10px 12px; border-radius:var(--radius-xs); cursor:pointer; transition:transform .04s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:focus-visible{outline:none; box-shadow:var(--ring)}
    .btn.primary{background:var(--accent); color:var(--accent-ink); border-color:color-mix(in oklab, var(--accent) 40%, var(--border))}
    .btn.ghost{background:transparent}
    .btn.mini{font-size:12px; padding:6px 8px}
    input[type="text"], input[type="url"], input[type="number"], textarea{
      border:1px solid var(--border); background:var(--surface-2); color:var(--text);
      padding:10px 12px; border-radius:var(--radius-xs)
    }
    textarea{min-height:96px; resize:vertical}
    .muted{color:var(--muted); font-size:12px}
    .card{background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px}
    .stack{display:grid; gap:14px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
    .pl-card{display:grid; gap:12px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--surface-2); padding:14px}
    .pl-head{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .cover{display:inline-grid; place-items:center; width:36px; height:36px; border-radius:8px; background:color-mix(in oklab, var(--accent) 18%, var(--surface)); font-size:18px}
    .title{font-weight:700}
    .tag{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; background:transparent; border:1px dashed var(--border); font-size:11px; color:var(--muted)}
    a.link{color:color-mix(in oklab, var(--accent) 88%, var(--text)); text-decoration:none; border-bottom:1px dashed color-mix(in oklab, var(--accent) 60%, var(--border))}
    a.link:hover{border-bottom-style:solid}
    .toast{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
      background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:10px 14px;
      box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(-4px)}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
    @media print{
      header, .btn, .controls{display:none !important}
      .pl-card{break-inside:avoid}
      body{background:#fff; color:#000}
    }
  </style>
</head>
<body>
  <a class="sr-only" href="#content">Skip to content</a>
  <div class="shell">
    <header>
      <div class="brand" aria-live="polite" aria-atomic="true">
        <div class="glyph" aria-hidden="true">⚡</div>
        <h1 id="brand">Tunes — Pairs</h1>
      </div>
      <div class="controls">
        <a id="openJar" class="btn ghost" href="#" target="_blank" rel="noopener">Open Jar</a>
        <label class="btn" for="importPairs" style="cursor:pointer">Import</label>
        <input id="importPairs" type="file" accept="application/json" hidden/>
        <button id="exportPairs" class="btn">Export</button>
        <button id="clearPairs" class="btn">Clear</button>
      </div>
    </header>

    <main id="content" class="stack" style="margin-top:18px">
      <section class="card stack">
        <div class="grid">
          <div class="stack">
            <h2 style="margin:0;font-size:16px">Build Pair</h2>
            <div class="row">
              <input id="aTitle" type="text" placeholder="Track A title" style="flex:2;min-width:220px"/>
              <input id="aUrl" type="url" placeholder="Track A URL" style="flex:2;min-width:240px"/>
            </div>
            <div class="row">
              <input id="bTitle" type="text" placeholder="Track B title" style="flex:2;min-width:220px"/>
              <input id="bUrl" type="url" placeholder="Track B URL" style="flex:2;min-width:240px"/>
            </div>
            <div class="row">
              <label>Focus <input id="focus" type="number" min="0" max="10" step="1" value="5" style="width:80px"/></label>
              <label>Lightness <input id="light" type="number" min="0" max="10" step="1" value="5" style="width:80px"/></label>
              <input id="pairTags" type="text" placeholder="#tags" style="flex:1;min-width:180px"/>
            </div>
            <textarea id="pairNotes" placeholder="Notes (optional)"></textarea>
            <div class="row" style="justify-content:space-between">
              <div class="controls">
                <button id="swapPair" class="btn">Swap</button>
                <button id="clearPair" class="btn">Clear</button>
              </div>
              <div class="controls">
                <a id="logPair" class="btn ghost" href="#" target="_blank" rel="noopener">Log to Jar</a>
                <button id="savePair" class="btn primary">Save Pair</button>
              </div>
            </div>
          </div>

          <div class="stack">
            <div class="row" style="justify-content:space-between; align-items:center">
              <h2 style="margin:0;font-size:16px">History</h2>
              <div class="muted" id="countBar" aria-live="polite"></div>
            </div>
            <div id="pairsList" class="stack"></div>
            <div id="pairsEmpty" class="muted">No pairs saved yet.</div>
          </div>
        </div>
      </section>

      <section class="card stack">
        <h2 style="margin:0;font-size:16px">About Data</h2>
        <p class="muted">Pairs are stored locally under a namespaced key. Export regularly if you need backups or to move devices.</p>
      </section>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <script defer>
    (function(){
      "use strict";

      const $  = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

      const els = {
        brand: $("#brand"),
        openJar: $("#openJar"),
        aTitle: $("#aTitle"),
        aUrl: $("#aUrl"),
        bTitle: $("#bTitle"),
        bUrl: $("#bUrl"),
        focus: $("#focus"),
        light: $("#light"),
        pairTags: $("#pairTags"),
        pairNotes: $("#pairNotes"),
        swapPair: $("#swapPair"),
        clearPair: $("#clearPair"),
        savePair: $("#savePair"),
        logPair: $("#logPair"),
        importPairs: $("#importPairs"),
        exportPairs: $("#exportPairs"),
        clearPairs: $("#clearPairs"),
        pairsList: $("#pairsList"),
        pairsEmpty: $("#pairsEmpty"),
        countBar: $("#countBar"),
        toast: $("#toast")
      };

      const cfg = (window.APP_CONFIG && typeof window.APP_CONFIG === "object") ? window.APP_CONFIG : {};
      const ns = cfg.namespace || cfg.appId || "plnt";
      const DBKEY = `tunes.v1.${ns}`;
      const accent = (cfg.theme && cfg.theme.accent) ? String(cfg.theme.accent) : null;
      if (accent) document.documentElement.style.setProperty("--accent", accent);
      if (cfg.brand || cfg.title){
        const label = `${cfg.brand || cfg.title}`.replace(/\s+—.*$/,"");
        els.brand.textContent = (label ? `${label} — Pairs` : "Tunes — Pairs");
        document.title = els.brand.textContent;
      }

      function showToast(msg){
        els.toast.textContent = msg;
        els.toast.classList.add("show");
        setTimeout(()=> els.toast.classList.remove("show"), 1400);
      }

      function parseTags(raw){
        if (!raw) return [];
        return raw.split(/[\s,]+/).map(s=>s.trim().replace(/^#/, "")).filter(Boolean).slice(0, 16);
      }
      function todayISO(){
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      }
      function humanDate(iso){
        const [y,m,d] = iso.split("-").map(Number);
        const dt = new Date(y, m-1, d);
        return dt.toLocaleDateString(undefined, {weekday:"short", year:"numeric", month:"short", day:"numeric"});
      }

      const memory = { db:null };
      function readDB(){
        if (memory.db) return JSON.parse(JSON.stringify(memory.db));
        try{
          const raw = localStorage.getItem(DBKEY);
          const obj = raw ? JSON.parse(raw) : {};
          const safe = {playlists: obj.playlists||[], pairs: obj.pairs||[]};
          memory.db = JSON.parse(JSON.stringify(safe));
          return safe;
        }catch(_){ return {playlists:[], pairs:[]}; }
      }
      function writeDB(obj){
        const safe = {playlists: obj.playlists||[], pairs: obj.pairs||[]};
        try{ localStorage.setItem(DBKEY, JSON.stringify(safe)); memory.db = JSON.parse(JSON.stringify(safe)); }
        catch(_){ memory.db = JSON.parse(JSON.stringify(safe)); }
      }

      function jarBase(){
        if (cfg.basePathJar){
          if (/^https?:\/\//i.test(cfg.basePathJar)) return cfg.basePathJar.replace(/\/?$/, "/");
          return cfg.basePathJar.replace(/\/?$/, "/");
        }
        const h = location.host;
        if (h.startsWith("tunes.")) return `${location.protocol}//jar.${h.slice(6)}/`;
        return "/jar/";
      }
      function jarLink({date, type, tags, text}){
        const d = date || new Date();
        const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
        const qp = new URLSearchParams();
        qp.set("date", iso);
        if (type) qp.set("type", type);
        if (tags && tags.length) qp.set("tags", tags.map(t=> t.startsWith("#")? t : "#"+t).join(" "));
        if (text) qp.set("text", text);
        return jarBase() + "day/?" + qp.toString();
      }

      function updateHeader(){
        $("#openJar").href = jarBase() + "index.html";
      }

      function updateLogPairLink(){
        const txt = `${String(els.aTitle.value||"A").trim()} → ${String(els.bTitle.value||"B").trim()} • F${els.focus.value}/L${els.light.value}`;
        els.logPair.href = jarLink({type:"Honey", tags:["tunes","pair"], text:txt, date:new Date()});
      }

      function savePair(){
        const aTitle = String(els.aTitle.value||"").trim();
        const aUrl = String(els.aUrl.value||"").trim();
        const bTitle = String(els.bTitle.value||"").trim();
        const bUrl = String(els.bUrl.value||"").trim();
        const focus = Number(els.focus.value||0);
        const light = Number(els.light.value||0);
        const tags = parseTags(els.pairTags.value);
        const notes = String(els.pairNotes.value||"").trim();
        const id = Math.random().toString(36).slice(2) + Date.now().toString(36);
        const p = {id, aTitle, aUrl, bTitle, bUrl, focus, light, tags, notes, createdAt: new Date().toISOString()};
        const db = readDB();
        db.pairs.push(p);
        writeDB(db);
        renderPairs();
        showToast("Pair saved");
      }

      function renderPairs(){
        const db = readDB();
        els.pairsList.innerHTML = "";
        const list = db.pairs.slice().sort((a,b)=> a.createdAt > b.createdAt ? -1 : 1);
        els.countBar.textContent = `${list.length} saved`;
        if (!list.length){
          els.pairsEmpty.style.display = "block";
          return;
        }
        els.pairsEmpty.style.display = "none";
        const frag = document.createDocumentFragment();
        list.forEach(p=>{
          const card = document.createElement("div");
          card.className = "pl-card";

          const head = document.createElement("div");
          head.className = "pl-head";
          const left = document.createElement("div");
          left.style.display = "flex";
          left.style.alignItems = "center";
          left.style.gap = "10px";
          const icon = document.createElement("div");
          icon.className = "cover";
          icon.textContent = "⚡";
          const title = document.createElement("div");
          title.className = "title";
          title.textContent = `${p.aTitle||"A"} → ${p.bTitle||"B"}`;
          left.appendChild(icon); left.appendChild(title);

          const right = document.createElement("div");
          right.className = "controls";
          const a = document.createElement("a");
          a.className = "btn mini"; a.href = p.aUrl||"#"; a.textContent = "A"; a.target="_blank"; a.rel="noopener";
          const b = document.createElement("a");
          b.className = "btn mini"; b.href = p.bUrl||"#"; b.textContent = "B"; b.target="_blank"; b.rel="noopener";
          const log = document.createElement("a");
          log.className = "btn mini ghost"; log.target="_blank"; log.rel="noopener";
          log.href = jarLink({type:"Honey", tags:["tunes","pair"], text:`${p.aTitle||"A"} → ${p.bTitle||"B"} • F${p.focus}/L${p.light}`});
          log.textContent = "Log to Jar";
          const del = document.createElement("button");
          del.className = "btn mini"; del.textContent = "Delete";
          del.addEventListener("click", ()=>{
            const next = db.pairs.filter(x => x.id !== p.id);
            writeDB({playlists: db.playlists, pairs: next});
            renderPairs();
            showToast("Pair deleted");
          });
          right.appendChild(a);
          right.appendChild(b);
          right.appendChild(log);
          right.appendChild(del);

          head.appendChild(left); head.appendChild(right);

          const meta = document.createElement("div");
          meta.className = "row";
          meta.appendChild(chip(`Date: ${humanDate((p.createdAt||"").slice(0,10)||todayISO())}`));
          meta.appendChild(chip(`F${p.focus}`));
          meta.appendChild(chip(`L${p.light}`));
          if (p.tags && p.tags.length){ p.tags.forEach(t=> meta.appendChild(tag(`#${t}`))); }
          else { meta.appendChild(muted("No tags")); }

          const notes = document.createElement("div");
          notes.className = "muted";
          notes.textContent = p.notes || "";

          card.appendChild(head);
          card.appendChild(meta);
          if (p.notes) card.appendChild(notes);
          frag.appendChild(card);
        });
        els.pairsList.appendChild(frag);
      }

      function chip(text){
        const n = document.createElement("div");
        n.className = "tag";
        n.textContent = text;
        return n;
      }
      function tag(text){
        const n = document.createElement("span");
        n.className = "tag";
        n.textContent = text;
        return n;
      }
      function muted(text){
        const n = document.createElement("span");
        n.className = "muted";
        n.textContent = text;
        return n;
      }

      function onExportPairs(){
        const db = readDB();
        const out = {pairs: db.pairs||[]};
        const blob = new Blob([JSON.stringify(out, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "tunes-pairs.json";
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      }
      function onImportPairs(file){
        if (!file) return;
        const fr = new FileReader();
        fr.onload = () => {
          let data;
          try{ data = JSON.parse(fr.result); }catch(_){ showToast("Invalid JSON"); return; }
          const db = readDB();
          const incoming = Array.isArray(data) ? data : (data.pairs||[]);
          const next = {playlists: db.playlists||[], pairs: (db.pairs||[]).concat(incoming)};
          writeDB(next);
          renderPairs();
          showToast("Imported pairs");
        };
        fr.readAsText(file);
      }

      function onClearPairs(){
        if (!confirm("Clear all saved pairs?")) return;
        const db = readDB();
        writeDB({playlists: db.playlists||[], pairs: []});
        renderPairs();
        showToast("Pairs cleared");
      }

      els.swapPair.addEventListener("click", ()=>{
        const t = els.aTitle.value, u = els.aUrl.value;
        els.aTitle.value = els.bTitle.value; els.aUrl.value = els.bUrl.value;
        els.bTitle.value = t; els.bUrl.value = u;
        updateLogPairLink();
      });
      els.clearPair.addEventListener("click", ()=>{
        els.aTitle.value = ""; els.aUrl.value = "";
        els.bTitle.value = ""; els.bUrl.value = "";
        els.focus.value = "5"; els.light.value = "5";
        els.pairTags.value = ""; els.pairNotes.value = "";
        updateLogPairLink();
      });
      els.savePair.addEventListener("click", (e)=>{ e.preventDefault(); savePair(); });

      ["aTitle","bTitle","focus","light"].forEach(id=>{
        els[id].addEventListener("input", updateLogPairLink);
      });

      els.importPairs.addEventListener("change", e => onImportPairs(e.target.files && e.target.files[0]));
      els.exportPairs.addEventListener("click", onExportPairs);
      els.clearPairs.addEventListener("click", onClearPairs);

      function init(){
        updateHeader();
        renderPairs();
        updateLogPairLink();
      }
      init();
    })();
  </script>
</body>
</html>
