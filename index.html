<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tunes Â· Illumina 1</title>
<meta name="theme-color" content="#0B0F19">
<meta name="description" content="Illumina 1 playlists with fixed header player. Loads tracks from /data/illumina/1 via manifest.json.">
<style>
  :root{
    --bg:#0B0F19;--ink:#EAECEF;--muted:#AAB2C0;--line:rgba(234,236,239,.16);
    --gold:#F5D142;--amber:#F59E0B;--ok:#34D399;--warn:#FBBF24;--err:#F87171;
    --r:14px;--pad:18px;--maxw:1100px;
    --playerH: clamp(220px, 28vw, 420px);
    --card:#0F1524;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding-top:calc(var(--playerH) + 110px)}
  a{color:var(--gold);text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:clamp(14px,3.5vw,28px)}
  header{display:grid;gap:8px;margin:6px 0 18px}
  h1{margin:0;font-size:clamp(22px,4.5vw,34px);line-height:1.2}
  .muted{color:var(--muted)}
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:13px;background:rgba(255,255,255,.02)}
  .btn{border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:rgba(255,255,255,.02);color:var(--ink);cursor:pointer}
  select,input[type="text"]{padding:10px 12px;border:1px solid rgba(255,255,255,.28);border-radius:999px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)),var(--card);color:var(--ink);font:inherit}
  .grid{display:grid;gap:12px}
  .cards{grid-template-columns:1fr}
  @media (min-width:840px){.cards{grid-template-columns:1fr 1fr}}
  .card{border:1px solid var(--line);border-radius:var(--r);padding:var(--pad);background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0))}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .mono{font-family:ui-monospace,Menlo,Consolas,monaco,Consolas,monospace}
  .tag{font-size:12px;color:#cfd3db;border:1px dashed var(--line);border-radius:8px;padding:2px 8px}
  .title{font-size:17px;font-weight:700;line-height:1.25}
  .meta{display:grid;gap:6px;margin-top:8px}
  .platforms{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .badge{font-size:12px;color:var(--muted);border:1px solid var(--line);border-radius:999px;padding:4px 8px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  footer{margin:24px 0 8px;color:var(--muted);font-size:13px;text-align:center}
  .lane{border:1px dashed var(--line);border-radius:999px;padding:6px 10px;color:#cfd3db}

  .playerbar{position:fixed;left:0;right:0;top:0;z-index:9999;background:rgba(11,15,25,.96);backdrop-filter:saturate(120%) blur(10px);border-bottom:1px solid var(--line)}
  .playerwrap{max-width:var(--maxw);margin:0 auto;padding:8px 0}
  .player-row{display:grid;gap:10px;grid-template-columns:1fr;align-items:center;padding:0 clamp(14px,3.5vw,28px)}
  @media (min-width:860px){.player-row{grid-template-columns:360px 1fr 260px}}
  .now{font-size:13px;color:var(--muted)} .now strong{color:#e9ecf3}
  .frame{position:relative;height:var(--playerH);border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#000}
  .frame #yt{position:absolute;inset:0;width:100%;height:100%}
  .controls{display:flex;gap:8px;justify-content:flex-end;align-items:center;flex-wrap:wrap}
  .navbtn{display:inline-flex;align-items:center;gap:8px;line-height:1;border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:rgba(255,255,255,.02);color:var(--ink)}
  .navbtn.primary{border-color:var(--amber);background:linear-gradient(180deg,rgba(245,158,11,.16),rgba(245,158,11,.1))}
  .switch{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted)}
  .switch input{accent-color:#34D399}
</style>
</head>
<body>
<script src="/api/config.js"></script>

<div class="playerbar" aria-label="Player">
  <div class="playerwrap">
    <div class="player-row">
      <div>
        <div class="now">Now Playing</div>
        <div id="nowTitle" class="mono" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">â€”</div>
        <div id="nowMeta" class="muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">â€”</div>
      </div>
      <div class="frame"><div id="yt"></div></div>
      <div class="controls">
        <label class="switch" title="ON: loop current video Â· OFF: auto-next">
          <input id="loopToggle" type="checkbox"> Loop
        </label>
        <button class="navbtn" id="prevBtn" type="button" aria-label="Previous">Prev</button>
        <button class="navbtn primary" id="nextBtn" type="button" aria-label="Next">Next</button>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <header>
    <h1>Illumina 1 â€” Tunes</h1>
    <div class="bar">
      <span id="cycle" class="pill">Loadingâ€¦</span>
      <a class="btn" href="/beacon/index.html">Beacon</a>
      <label class="pill" for="lane">Lane</label>
      <select id="lane" aria-label="Choose playlist lane"></select>
      <label class="pill" for="search">Search</label>
      <input id="search" type="text" placeholder="Title, figure, seedâ€¦">
      <select id="dayJump" aria-label="Jump to day"><option value="">Jump to dayâ€¦</option></select>
    </div>
  </header>

  <section id="cards" class="grid cards" aria-live="polite"></section>

  <footer><p>PLNT Earth Â· Illumina â€” Tunes</p></footer>
</div>

<script>
(function(){
  var cfg = (window.ILLUMINA_CONFIG) || {
    baseUrl:"/data",
    activeIllumina:1,
    routes:{ manifest:function(n){return "/data/illumina/"+n+"/manifest.json";}, anchors:"/data/anchors", pollen:"/pollen/index.json" }
  };
  var q = new URLSearchParams(location.search);
  var prefLane = (q.get('lane')||'anchor-public').toLowerCase();
  var manifestUrl = (cfg.routes && cfg.routes.manifest) ? cfg.routes.manifest(cfg.activeIllumina) : (cfg.baseUrl+"/illumina/"+cfg.activeIllumina+"/manifest.json");
  var manifest=null, tracks={}, laneList=[], laneId=prefLane;
  var data=null, items=[], playOrder=[], currentIndex=-1, player, playerReady=false, queuedId=null, loopMode=false;

  var elCards = document.getElementById('cards');
  var elCycle = document.getElementById('cycle');
  var elSearch = document.getElementById('search');
  var elDayJump = document.getElementById('dayJump');
  var elLaneSel = document.getElementById('lane');
  var elNowTitle = document.getElementById('nowTitle');
  var elNowMeta = document.getElementById('nowMeta');
  var prevBtn = document.getElementById('prevBtn');
  var nextBtn = document.getElementById('nextBtn');
  var loopToggle = document.getElementById('loopToggle');

  function ujoin(base, rel){ try{ return new URL(rel, base).href; }catch(e){ return rel; } }
  function extractYouTubeID(u){ if(!u) return ""; var s=String(u); var m=s.match(/[?&]v=([^&]+)/)||s.match(/youtu\.be\/([^?&]+)/)||s.match(/embed\/([^?&]+)/); return m?m[1]:""; }
  function validYT(u){ return !!(u && /youtube\.com|youtu\.be/i.test(String(u))); }
  function moonEmoji(dateStr){ var d=new Date((dateStr||'')+'T00:00:00Z'); var syn=29.53058867; var base=Date.UTC(2025,0,29); var days=(Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate())-base)/86400000; var ph=((days%syn)+syn)%syn; var idx=Math.floor((ph/syn)*8+0.5)%8; return ['ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜'][idx]; }

  function renderLaneOptions(){
    elLaneSel.innerHTML = laneList.map(function(t){ return '<option value="'+t.id+'">'+t.label+'</option>'; }).join('');
    elLaneSel.value = laneId;
  }

  function buildOrder(){
    playOrder = [];
    for(var i=0;i<items.length;i++){
      var it = items[i]||{};
      var yt = it.urls && it.urls.youtube;
      if(validYT(yt)) playOrder.push(it.day);
    }
  }

  function updateNow(it){
    elNowTitle.textContent = it.title||'â€”';
    elNowMeta.textContent  = 'Day '+(it.day||'â€“')+' Â· '+(it.date||'')+' Â· '+(it.moonPhase||'');
  }

  function playByDay(day){
    var it = items.find(function(x){return x.day===day;});
    if(!it) return;
    var yt = it.urls && it.urls.youtube || '';
    var id = extractYouTubeID(yt);
    if(!id) return;
    currentIndex = playOrder.indexOf(day);
    updateNow(it);
    if(player && playerReady){ player.loadVideoById(id); } else { queuedId = id; }
    var el = document.getElementById('day-'+day);
    if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
  }
  function playNext(){ if(playOrder.length===0) return; if(currentIndex<0){ currentIndex=0; } else { currentIndex = (currentIndex+1)%playOrder.length; } playByDay(playOrder[currentIndex]); }
  function playPrev(){ if(playOrder.length===0) return; if(currentIndex<=0){ currentIndex = (playOrder.length-1); } else { currentIndex -= 1; } playByDay(playOrder[currentIndex]); }

  window.onYouTubeIframeAPIReady = function(){
    player = new YT.Player('yt', {
      width:'100%', height:'100%', playerVars:{rel:0,modestbranding:1,playsinline:1},
      events:{
        onReady:function(){ playerReady=true; if(queuedId){ player.loadVideoById(queuedId); queuedId=null; } },
        onStateChange:function(e){ if(e.data===YT.PlayerState.ENDED){ if(loopMode){ try{player.seekTo(0,true); player.playVideo();}catch(_){}} else { playNext(); } } }
      }
    });
  };

  (function(){ if(!(window.YT&&YT.Player)){ var s=document.createElement('script'); s.src="https://www.youtube.com/iframe_api"; s.async=true; document.head.appendChild(s);} })();

  try{ loopMode = localStorage.getItem('tunes.loop')==='1'; loopToggle.checked = loopMode; }catch(e){}
  loopToggle.addEventListener('change', function(){ loopMode = !!this.checked; try{ localStorage.setItem('tunes.loop', loopMode?'1':'0'); }catch(e){} });

  function render(){
    var rows=[], term=(elSearch.value||'').toLowerCase();
    for(var i=0;i<items.length;i++){
      var it = items[i];
      var match = !term || (String(it.title||'').toLowerCase().indexOf(term)>-1) || (String(it.figure||'').toLowerCase().indexOf(term)>-1) || (String(it.seedRitual||'').toLowerCase().indexOf(term)>-1);
      if(!match) continue;
      var yt = it.urls && it.urls.youtube;
      var jar = 'https://jar.plnt.earth/day/?date='+encodeURIComponent(it.date||'')+'&playlist='+encodeURIComponent(laneId);
      rows.push(
        '<article class="card" id="day-'+it.day+'">'+
          '<div class="row">'+
            '<span class="tag">Day '+it.day+'</span>'+
            '<span class="tag mono">'+(it.date||'')+'</span>'+
            '<span class="tag">'+(it.moonPhase||'')+'</span>'+
            '<button class="btn" type="button" data-play="'+it.day+'">Play</button>'+
            '<a class="btn" href="'+jar+'" target="_blank" rel="noopener">Jar Day</a>'+
            '<button class="btn" type="button" data-share="'+it.day+'">Share</button>'+
          '</div>'+
          '<div class="meta">'+
            '<div class="title">'+(it.title||'â€”')+'</div>'+
            (it.figure?'<div class="muted">Figure: '+it.figure+'</div>':'')+
            (it.seedRitual?'<div class="muted">Seed: '+it.seedRitual+'</div>':'')+
            '<div class="platforms">'+
              (yt?'<span class="badge ok">YouTube ready</span>':'<span class="badge err">YouTube missing</span>')+
              '</div>'+
          '</div>'+
        '</article>'
      );
    }
    elCards.innerHTML = rows.join('');
    var total = items.length||0;
    elCycle.textContent = 'Cycle: '+(manifest.dates.start||'â€”')+' â†’ '+(manifest.dates.end||'â€”')+' Â· Days: '+total+'/42';
    buildOrder();

    elCards.querySelectorAll('button[data-play]').forEach(function(b){
      b.addEventListener('click', function(){ var d=+this.getAttribute('data-play'); playByDay(d); });
    });
    elCards.querySelectorAll('button[data-share]').forEach(function(b){
      b.addEventListener('click', function(){
        var d=this.getAttribute('data-share');
        var u=new URL(location.href); u.searchParams.set('lane', laneId); u.searchParams.set('day', d);
        if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(u.toString()); }
        var self=this; this.textContent='Copied!'; setTimeout(function(){ self.textContent='Share'; }, 900);
      });
    });

    var startDay = parseInt((new URLSearchParams(location.search)).get('day')||'',10);
    if(!isNaN(startDay) && document.getElementById('day-'+startDay)){ playByDay(startDay); }
  }

  function buildDayJump(){
    var opts=['<option value="">Jump to dayâ€¦</option>'];
    for(var i=1;i<=Math.max(42, items.length||0);i++){ opts.push('<option value="'+i+'">Day '+i+'</option>'); }
    elDayJump.innerHTML = opts.join('');
  }

  elSearch.addEventListener('input', render);
  elDayJump.addEventListener('change', function(){ var v=parseInt(this.value||'',10); var el=document.getElementById('day-'+v); if(el) el.scrollIntoView({behavior:'smooth',block:'start'}); });
  elLaneSel.addEventListener('change', function(){ laneId=this.value; loadLane(); });
  prevBtn.addEventListener('click', playPrev);
  nextBtn.addEventListener('click', playNext);
  window.addEventListener('keydown', function(e){ if(e.altKey && e.key==='ArrowLeft') playPrev(); if(e.altKey && e.key==='ArrowRight') playNext(); });
  window.addEventListener('resize', function(){ var bar=document.querySelector('.playerbar'); if(!bar) return; document.body.style.paddingTop=Math.ceil(bar.getBoundingClientRect().height+8)+'px'; }, {passive:true});
  window.addEventListener('orientationchange', function(){ var bar=document.querySelector('.playerbar'); if(!bar) return; document.body.style.paddingTop=Math.ceil(bar.getBoundingClientRect().height+8)+'px'; }, {passive:true});

  function findTrack(id){ var t=(manifest.tracks||[]).find(function(x){return x.id===id;}); return t? ujoin(manifestUrl, t.path) : null; }

  function loadLane(){
    var url = findTrack(laneId);
    if(!url){ items=[]; render(); return; }
    fetch(url,{cache:'no-store'}).then(function(r){return r.json()}).then(function(j){
      data=j||{}; items=Array.isArray(data.items)?data.items.slice(0):[]; buildDayJump(); render();
    }).catch(function(){ items=[]; render(); });
  }

  fetch(manifestUrl,{cache:'no-store'}).then(function(r){return r.json()}).then(function(m){
    manifest=m||{dates:{start:'',end:'',days:42},tracks:[]};
    laneList=(manifest.tracks||[]).map(function(t){ return {id:t.id,label:(t.label||t.id)}; });
    if(!laneList.length){ laneList=[{id:'anchor-public',label:'AnchorPublic'}]; }
    if(!laneList.some(function(t){return t.id===laneId;})){ laneId=(laneList.find(function(t){return t.id==='anchor-public';})||laneList[0]).id; }
    renderLaneOptions();
    loadLane();
  });
})();
</script>
</body>
</html>
