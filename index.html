<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tunes Â· Illumina 1 (Public)</title>
<meta name="theme-color" content="#0B0F19">
<meta name="description" content="Illumina 1 playlist with an embedded player. YouTube is canonical; Apple Music and Spotify shown when available. Includes moon phases, figure, seed rituals, Jar day links, and auto-next playback.">
<style>
  :root{
    --bg:#0B0F19;--ink:#E5E7EB;--muted:#9CA3AF;--line:rgba(229,231,235,.15);
    --gold:#F5D142;--amber:#F59E0B;--ok:#34D399;--warn:#FBBF24;--err:#F87171;
    --r:14px;--pad:18px;--maxw:1100px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
        /* reserve space for the fixed header (updates on resize via JS too) */
        padding-top: 260px;}
  a{color:var(--gold);text-decoration:none}
  a:hover{text-decoration:underline}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:clamp(14px,3.5vw,28px)}
  header{display:grid;gap:8px;margin:6px 0 18px}
  h1{margin:0;font-size:clamp(22px,4.5vw,34px);line-height:1.2}
  .muted{color:var(--muted)}
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:13px}
  .btn{border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:rgba(255,255,255,.02);color:var(--ink);cursor:pointer}
  .btn.primary{border-color:var(--amber);background:linear-gradient(180deg,rgba(245,209,66,.15),rgba(245,158,11,.12))}
  input[type="text"], select{
    padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.02);color:var(--ink);font:inherit;
  }
  .grid{display:grid;gap:12px}
  .cards{grid-template-columns:1fr}
  @media (min-width:840px){.cards{grid-template-columns:1fr 1fr}}
  .card{border:1px solid var(--line);border-radius:var(--r);padding:var(--pad);background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0))}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .tag{font-size:12px;color:#cfd3db;border:1px dashed var(--line);border-radius:8px;padding:2px 8px}
  .title{font-size:17px;font-weight:700;line-height:1.25}
  .artist{opacity:.9}
  .meta{display:grid;gap:6px;margin-top:8px}
  .platforms{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .play{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:10px;padding:8px 12px;background:rgba(255,255,255,.03)}
  .badge{font-size:12px;color:var(--muted);border:1px solid var(--line);border-radius:999px;padding:4px 8px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  footer{margin:24px 0 8px;color:var(--muted);font-size:13px;text-align:center}
  .lane{border:1px dashed var(--line);border-radius:999px;padding:6px 10px;color:#cfd3db}
  .share{margin-left:auto}

  /* Fixed player header */
  .playerbar{position:fixed;left:0;right:0;top:0;z-index:9999;background:rgba(11,15,25,.96);backdrop-filter:saturate(120%) blur(10px);border-bottom:1px solid var(--line)}
  .playerwrap{max-width:var(--maxw);margin:0 auto;padding:8px 0 8px}
  .player-row{display:grid;gap:10px;grid-template-columns:1fr;align-items:center;padding:0 clamp(14px,3.5vw,28px)}
  @media (min-width:860px){.player-row{grid-template-columns:360px 1fr 170px}}
  .now{font-size:13px;color:var(--muted)}
  .now strong{color:#e9ecf3}
  .frame{position:relative;aspect-ratio:16/9;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:rgba(255,255,255,.03)}
  .frame #yt{position:absolute;inset:0}
  .controls{display:flex;gap:8px;justify-content:flex-end;align-items:center}
</style>
</head>
<body>
<!-- Fixed player -->
<div class="playerbar" aria-label="Player">
  <div class="playerwrap">
    <div class="player-row">
      <div>
        <div class="now">Now Playing</div>
        <div id="nowTitle" class="mono" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">â€”</div>
        <div id="nowMeta" class="muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">â€”</div>
      </div>
      <div class="frame"><div id="yt"></div></div>
      <div class="controls">
        <button class="btn" id="prevBtn" type="button">âŸ¨ Prev</button>
        <button class="btn" id="nextBtn" type="button">Next âŸ©</button>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <header>
    <h1>Illumina 1 â€” Public Tunes</h1>
    <div class="bar">
      <span id="cycle" class="pill">Loadingâ€¦</span>
      <label class="pill" for="lane">Lane</label>
      <select id="lane" aria-label="Choose playlist lane">
        <option value="Explainer">Explainer</option>
        <option value="AnchorPublic">AnchorPublic</option>
        <option value="AnchorBuilt">AnchorBuilt</option>
      </select>
      <label class="pill" for="search">Search</label>
      <input id="search" type="text" placeholder="Title, artist, figure, seedâ€¦">
      <select id="dayJump" aria-label="Jump to day"><option value="">Jump to dayâ€¦</option></select>
      <button id="toggleMissing" class="btn" type="button">Show only missing YouTube</button>
      <button id="reload" class="btn" type="button">Reload</button>
      <span id="stat" class="pill">â€”</span>
    </div>
    <p class="muted">YouTube plays inline. Apple Music / Spotify shown when available.</p>
  </header>

  <section id="cards" class="grid cards" aria-live="polite"></section>

  <footer>
    <p>PLNT Earth Â· Illumina â€” Tunes</p>
    <p class="muted">Source JSON: <span class="mono" id="srcLabel">/Illumina1_Playlist_MASTER_3in1.json</span> Â· Lane: <span id="laneLabel" class="lane">Explainer</span></p>
  </footer>
</div>

<!-- Safe YouTube Iframe API loader -->
<script>
  (function loadYT(){
    if (window.YT && YT.Player) return;
    var s = document.createElement('script');
    s.src = "https://www.youtube.com/iframe_api";
    s.async = true;
    document.head.appendChild(s);
  })();
</script>

<script>
(function(){
  /* === Config === */
  var JAR_DAY_BASE = 'https://jar.plnt.earth/day/?date=';

  /* === State === */
  var q = new URLSearchParams(location.search);
  var src = q.get('src') || '/Illumina1_Playlist_MASTER_3in1.json';
  var data = null, filtered = false, term = '';
  var curLane = q.get('lane') || 'Explainer';
  var startDay = parseInt(q.get('day')||'',10);
  var playOrder = [];    // array of Day numbers in order (filtered to playable)
  var currentIndex = -1; // index within playOrder
  var player, playerReady = false, queuedId = null;

  /* === Elements === */
  var elCards = document.getElementById('cards');
  var elCycle = document.getElementById('cycle');
  var elStat = document.getElementById('stat');
  var elSearch = document.getElementById('search');
  var elMissing = document.getElementById('toggleMissing');
  var elReload = document.getElementById('reload');
  var elDayJump = document.getElementById('dayJump');
  var elLaneSel = document.getElementById('lane');
  var elLaneLabel = document.getElementById('laneLabel');
  var elSrcLabel = document.getElementById('srcLabel');
  var elNowTitle = document.getElementById('nowTitle');
  var elNowMeta = document.getElementById('nowMeta');
  var prevBtn = document.getElementById('prevBtn');
  var nextBtn = document.getElementById('nextBtn');

  elSrcLabel.textContent = src;
  elLaneSel.value = curLane;
  elLaneLabel.textContent = curLane;

  // Adjust body padding to fixed header height (for iOS)
  function syncHeaderHeight(){
    var bar = document.querySelector('.playerbar');
    if(!bar) return;
    var h = bar.getBoundingClientRect().height;
    document.body.style.paddingTop = Math.ceil(h+8) + 'px';
  }
  window.addEventListener('resize', syncHeaderHeight, {passive:true});
  window.addEventListener('orientationchange', syncHeaderHeight, {passive:true});
  setTimeout(syncHeaderHeight, 50);

  function setStat(t){ elStat.textContent = t; }
  function safe(v){ return v==null ? "" : String(v); }

  // Fix common UTF-8 mojibake for display only
  function fixMojibake(s){
    if(!s) return s;
    var map = {
      "BeyoncÃƒÂ©":"BeyoncÃ©","MÃƒÂ¥neskin":"MÃ¥neskin","ChloÃƒÂ«":"ChloÃ«","ZoÃƒÂ«":"ZoÃ«",
      "ÃƒÂ©":"Ã©","ÃƒÃ¨":"Ã¨","ÃƒÂª":"Ãª","ÃƒÂ«":"Ã«","ÃƒÂ¡":"Ã¡","ÃƒÃ ":"Ã ","ÃƒÂ­":"Ã­","ÃƒÂ³":"Ã³","ÃƒÂº":"Ãº","ÃƒÂ±":"Ã±",
      "ÃƒÅ“":"Ãœ","ÃƒÂ¼":"Ã¼","ÃƒÂ¶":"Ã¶","Ãƒâ€ž":"Ã„","ÃƒÂ¤":"Ã¤","Ãƒâ€¦":"Ã…","ÃƒÂ¥":"Ã¥",
      "Ã¢â‚¬â€œ":"â€“","Ã¢â‚¬â€":"â€”","Ã¢â‚¬Ëœ":"â€˜","Ã¢â‚¬â„¢":"â€™","Ã¢â‚¬Å“":"â€œ","Ã¢â‚¬Â":"â€","Ã¢â‚¬Â¢":"â€¢","Ã¢â‚¬Â¦":"â€¦"
    };
    var out = s;
    for(var k in map){ out = out.split(k).join(map[k]); }
    return out;
  }

  function moonEmoji(dateStr){
    var d = new Date(dateStr+'T00:00:00Z');
    var syn = 29.53058867;
    var base = Date.UTC(2025,0,29);
    var days = (Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()) - base)/86400000;
    var phase = ((days % syn) + syn) % syn;
    var idx = Math.floor((phase/syn)*8+0.5)%8;
    return ['ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜'][idx];
  }

  function extractYouTubeID(u){
    if(!u) return "";
    var s = String(u);
    var m = s.match(/[?&]v=([^&]+)/) || s.match(/youtu\.be\/([^?&]+)/) || s.match(/embed\/([^?&]+)/);
    return m ? m[1] : "";
  }

  function validYT(u){
    if(!u) return false;
    var s = String(u).trim();
    return /^https?:\/\//i.test(s) && /youtube\.com|youtu\.be/i.test(s);
  }

  function appleHref(platforms, title, artist){
    var p = platforms && platforms.AppleMusic;
    if(p && p.id){ return 'https://music.apple.com/us/album/'+encodeURIComponent(p.id); }
    var qq = encodeURIComponent((title||'') + ' ' + (artist||''));
    return 'https://music.apple.com/us/search?term='+qq;
  }

  function spotifyHref(platforms, title, artist){
    var p = platforms && platforms.Spotify;
    if(p && p.id){ return 'https://open.spotify.com/track/'+encodeURIComponent(p.id); }
    var qq = encodeURIComponent((title||'') + ' ' + (artist||''));
    return 'https://open.spotify.com/search/'+qq;
  }

  function matchRow(row, fig, seed){
    if(!term) return true;
    var t = term.toLowerCase();
    return (
      (safe(row.title).toLowerCase().indexOf(t)>-1) ||
      (safe(row.artist).toLowerCase().indexOf(t)>-1) ||
      (safe(fig).toLowerCase().indexOf(t)>-1) ||
      (safe(seed).toLowerCase().indexOf(t)>-1)
    );
  }

  function shareUrl(day){
    var u = new URL(location.href);
    u.searchParams.set('lane', curLane);
    u.searchParams.set('day', day);
    return u.toString();
  }

  function buildOrder(){
    playOrder = [];
    if(!data || !data.PerDay) return;
    for (var i=0;i<data.PerDay.length;i++){
      var base = data.PerDay[i];
      var laneRow = base[curLane] || {};
      var pf = laneRow.Platforms || {};
      var yt = safe(pf.YouTube && pf.YouTube.url);
      if(!yt) continue;
      if(filtered && yt) continue; // when showing only missing, don't queue
      if(matchRow(laneRow, base.Figure, base.SeedRitual)){
        playOrder.push(base.Day);
      }
    }
  }

  function updateNow(day, laneRow, dateStr){
    elNowTitle.textContent = fixMojibake(safe(laneRow.title));
    elNowMeta.textContent  = fixMojibake(safe(laneRow.artist)) + ' Â· Day '+day+' Â· '+(dateStr||'')+' Â· '+moonEmoji(dateStr||'');
  }

  function playByDay(day){
    if(!data || !data.PerDay) return;
    var base = data.PerDay[day-1] || {};
    var laneRow = base[curLane] || {};
    var pf = laneRow.Platforms || {};
    var yt = safe(pf.YouTube && pf.YouTube.url);
    var id = extractYouTubeID(yt);
    if(!id) return;

    updateNow(day, laneRow, base.Date || '');
    currentIndex = playOrder.indexOf(day);

    if (player && playerReady){
      player.loadVideoById(id);
    } else {
      queuedId = id; // wait for API ready
    }

    // bring card into view
    var el = document.getElementById('day-'+day);
    if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
  }

  function playNext(){
    if(playOrder.length===0) return;
    if(currentIndex < 0){ currentIndex = 0; }
    else { currentIndex = Math.min(currentIndex + 1, playOrder.length - 1); }
    playByDay(playOrder[currentIndex]);
  }
  function playPrev(){
    if(playOrder.length===0) return;
    if(currentIndex <= 0){ currentIndex = 0; }
    else { currentIndex = currentIndex - 1; }
    playByDay(playOrder[currentIndex]);
  }

  // Public render
  function render(){
    if(!data || !data.PerDay){ elCards.innerHTML=''; elCycle.textContent='No data'; return; }
    var list = data.PerDay.slice();
    var total = list.length;
    var missing = 0, warn = 0, ok = 0;
    var rows = [];

    for(var i=0;i<list.length;i++){
      var base = list[i];
      var laneRow = base[curLane] || {};
      var fig = safe(base.Figure);
      var seed = safe(base.SeedRitual);
      if(!matchRow(laneRow, fig, seed)) continue;

      var day = base.Day, date = base.Date;
      var title = fixMojibake(safe(laneRow.title));
      var artist = fixMojibake(safe(laneRow.artist));
      var pf = laneRow.Platforms || {};
      var yt = safe(pf.YouTube && pf.YouTube.url);
      var ytOk = validYT(yt);
      if(filtered && yt) continue;
      if(!yt) missing++; else if(ytOk) ok++; else warn++;

      var jarHref = JAR_DAY_BASE + encodeURIComponent(date || '');

      rows.push(
        '<article class="card" id="day-'+day+'">'+
          '<div class="row">'+
            '<span class="tag">Day '+day+'</span>'+
            '<span class="tag mono">'+date+'</span>'+
            '<span class="tag">'+curLane+'</span>'+
            '<span class="tag">'+(date?moonEmoji(date):"")+'</span>'+
            '<button class="btn" type="button" data-play="'+day+'">Play</button>'+
            (curLane==='Explainer' ? '<a class="btn" href="'+jarHref+'" target="_blank" rel="noopener">Jar Day</a>' : '')+
            '<button class="btn share" type="button" data-share="'+day+'">Share</button>'+
          '</div>'+
          '<div class="meta">'+
            '<div class="title">'+title+'</div>'+
            '<div class="artist">'+artist+'</div>'+
            (fig?'<div class="muted">Figure: '+fixMojibake(fig)+'</div>':'')+
            (seed?'<div class="muted">Seed: '+fixMojibake(seed)+'</div>':'')+
            '<div class="platforms">'+
              (yt ? '<span class="badge ok">YouTube ready</span>' :
                    '<span class="badge err">YouTube link missing</span>')+
              '<a class="play" href="'+appleHref(pf, title, artist)+'" target="_blank" rel="noopener">ï£¿ Apple Music'+((pf.AppleMusic&&pf.AppleMusic.status==='exists')?'':' (search)')+'</a>'+
              '<a class="play" href="'+spotifyHref(pf, title, artist)+'" target="_blank" rel="noopener">Spotify'+((pf.Spotify&&pf.Spotify.id)?'':' (search)')+'</a>'+
            '</div>'+
            (yt && !ytOk ? '<div class="warn">Please check this YouTube URL.</div>':'')+
          '</div>'+
        '</article>'
      );
    }
    elCards.innerHTML = rows.join('');
    var start = data.Cycle && data.Cycle.Start ? data.Cycle.Start : 'â€”';
    var end = data.Cycle && data.Cycle.End ? data.Cycle.End : 'â€”';
    elCycle.textContent = 'Cycle: '+start+' â†’ '+end+' Â· Days: '+total;
    setStat('OK: '+ok+' Â· Missing: '+missing+' Â· Check: '+warn);

    buildOrder();

    // wire buttons
    elCards.querySelectorAll('button[data-play]').forEach(function(b){
      b.addEventListener('click', function(){
        var d = +this.getAttribute('data-play');
        playByDay(d);
      });
    });
    elCards.querySelectorAll('button[data-share]').forEach(function(b){
      b.addEventListener('click', function(){
        var d = this.getAttribute('data-share');
        var u = new URL(location.href);
        u.searchParams.set('lane', curLane);
        u.searchParams.set('day', d);
        if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(u.toString()); }
        this.textContent = 'Copied!';
        var self = this; setTimeout(function(){ self.textContent='Share'; }, 1000);
      });
    });

    // auto-start if deep-linked
    if(startDay && document.getElementById('day-'+startDay)){
      playByDay(startDay);
      startDay = null;
    }
  }

  function buildDayJump(){
    if(!data || !data.PerDay) return;
    var opts = ['<option value="">Jump to dayâ€¦</option>'];
    for(var i=0;i<data.PerDay.length;i++){
      var d = data.PerDay[i].Day || (i+1);
      opts.push('<option value="'+d+'">Day '+d+'</option>');
    }
    elDayJump.innerHTML = opts.join('');
  }

  function jumpTo(day){
    var el = document.getElementById('day-'+day);
    if(!el) return;
    el.scrollIntoView({behavior:'smooth', block:'start'});
  }

  function load(){
    setStat('Loadingâ€¦');
    fetch(src, {cache:'no-store'}).then(function(r){
      if(!r.ok) throw new Error('Load failed');
      return r.json();
    }).then(function(json){
      data = json;
      buildDayJump();
      render();
      setStat('Loaded');
    }).catch(function(){
      setStat('Could not load JSON');
      elCards.innerHTML = '';
      elCycle.textContent = 'Load error';
    });
  }

  // UI bindings
  elSearch.addEventListener('input', function(){ term = this.value.trim(); render(); });
  elMissing.addEventListener('click', function(){
    filtered = !filtered;
    this.textContent = filtered ? 'Show all' : 'Show only missing YouTube';
    render();
  });
  elReload.addEventListener('click', load);
  elDayJump.addEventListener('change', function(){ if(this.value) jumpTo(this.value); });
  elLaneSel.addEventListener('change', function(){ curLane = this.value; elLaneLabel.textContent = curLane; render(); });
  prevBtn.addEventListener('click', playPrev);
  nextBtn.addEventListener('click', playNext);

  // YouTube API hookup (global callback)
  window.onYouTubeIframeAPIReady = function(){
    player = new YT.Player('yt', {
      width: '100%', height: '100%',
      playerVars: { rel:0, modestbranding:1, playsinline:1 },
      events: {
        onReady: function(){
          playerReady = true;
          if(queuedId){ player.loadVideoById(queuedId); queuedId = null; }
        },
        onStateChange: function(e){
          if(e.data === YT.PlayerState.ENDED){ playNext(); }
        }
      }
    });
  };

  load();
})();
</script>
</body>
</html>
