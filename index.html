<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Illumina 1 — Tunes</title>
<meta name="theme-color" content="#0B0F19">
<meta name="description" content="Illumina 1 playlists with an embedded player. AnchorPublic is default; switch lanes anytime.">
<style>
  :root{
    --bg:#0B0F19;--ink:#EAECEF;--muted:#AAB2C0;--line:rgba(234,236,239,.16);
    --gold:#F5D142;--amber:#F59E0B;--ok:#34D399;--warn:#FBBF24;--err:#F87171;
    --r:14px;--pad:18px;--maxw:1100px;--card:#0F1524
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--gold);text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:clamp(14px,3.5vw,28px)}
  header{display:grid;gap:8px;margin:6px 0 18px}
  h1{margin:0;font-size:clamp(22px,4.5vw,34px);line-height:1.2}
  .muted{color:var(--muted)}
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:#dbe0ea;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}
  select,input{appearance:none;border:1px solid rgba(255,255,255,.28);border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,.09),rgba(255,255,255,.02)),var(--card);color:var(--ink);padding:8px 10px}
  select:focus,input:focus{outline:2px solid rgba(164,232,255,.65);outline-offset:2px;box-shadow:0 0 0 2px rgba(164,232,255,.18)}
  .grid{display:grid;gap:12px}
  .cards{grid-template-columns:1fr}
  @media (min-width:840px){.cards{grid-template-columns:1fr 1fr}}
  .card{border:1px solid var(--line);border-radius:var(--r);padding:var(--pad);background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0))}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .tag{font-size:12px;color:#cfd3db;border:1px dashed var(--line);border-radius:8px;padding:2px 8px}
  .title{font-size:17px;font-weight:700;line-height:1.25}
  .artist{opacity:.9}
  .meta{display:grid;gap:6px;margin-top:8px}
  .platforms{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .play{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:10px;padding:8px 12px;background:rgba(255,255,255,.03)}
  .badge{font-size:12px;color:var(--muted);border:1px solid var(--line);border-radius:999px;padding:4px 8px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  footer{margin:24px 0 8px;color:var(--muted);font-size:13px;text-align:center}
  .lane{border:1px dashed var(--line);border-radius:999px;padding:6px 10px;color:#cfd3db}

  /* Fixed player header with aspect-ratio (prevents overflow) */
  .playerbar{position:sticky;top:0;z-index:9999;background:rgba(11,15,25,.96);backdrop-filter:saturate(120%) blur(10px);border-bottom:1px solid var(--line)}
  .playerwrap{max-width:var(--maxw);margin:0 auto;padding:8px 0}
  .player-row{display:grid;gap:10px;grid-template-columns:1fr;align-items:center;padding:0 clamp(14px,3.5vw,28px)}
  @media (min-width:880px){.player-row{grid-template-columns:360px 1fr 300px}}
  .now{font-size:13px;color:var(--muted)} .now strong{color:#e9ecf3}
  .frame{position:relative;width:100%;aspect-ratio:16/9;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#000;max-width:100%}
  .frame iframe{position:absolute;inset:0;width:100%;height:100%;border:0}

  .controls{display:flex;gap:8px;justify-content:flex-end;align-items:center;flex-wrap:wrap}
  .navbtn{display:inline-flex;align-items:center;gap:8px;line-height:1;border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:rgba(255,255,255,.02);color:var(--ink)}
  .navbtn.primary{border-color:var(--amber);background:linear-gradient(180deg,rgba(245,158,11,.16),rgba(245,158,11,.1))}
  .switch{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:#dbe0ea}
  .switch input{accent-color:#34D399}

  /* View modes for the video */
  .collapsed{display:none}
  .tall{aspect-ratio:auto;height:min(70vh, 70svh)}

</style>
</head>
<body>
<script src="/api/config.js"></script>
<div class="playerbar" aria-label="Player">
  <div class="playerwrap">
    <div class="player-row">
      <div>
        <div class="now">Now Playing</div>
        <div id="nowTitle" class="mono" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">—</div>
        <div id="nowMeta" class="muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">—</div>
      </div>
      <div class="frame"><iframe id="yt" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe></div>
      <div class="controls">
        <label class="switch" title="ON: loop current video · OFF: auto-next"><input id="loopToggle" type="checkbox"> Loop</label>
        <button class="navbtn" id="minBtn" type="button" aria-label="Minimize">Min</button>
        <button class="navbtn" id="fillBtn" type="button" aria-label="Fill header">Fill</button>
        <button class="navbtn" id="fsBtn" type="button" aria-label="Fullscreen">Full</button>
        <button class="navbtn" id="prevBtn" type="button" aria-label="Previous">Prev</button>
        <button class="navbtn primary" id="nextBtn" type="button" aria-label="Next">Next</button>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <header>
    <h1>Illumina 1 — Tunes</h1>
    <div class="bar">
      <span id="cycle" class="pill">Loading…</span>
      <label class="pill" for="lane">Lane</label>
      <select id="lane" aria-label="Choose playlist lane">
        <option value="anchor-public">AnchorPublic</option>
        <option value="explainer">Explainer</option>
        <option value="anchor-built">AnchorBuilt</option>
      </select>
      <label class="pill" for="search">Search</label>
      <input id="search" type="text" placeholder="Title, artist, seed…">
      <select id="dayJump" aria-label="Jump to day"><option value="">Jump to day…</option></select>
    </div>
  </header>

  <section id="cards" class="grid cards" aria-live="polite"></section>

  <footer><p>PLNT Earth · Illumina — Tunes</p></footer>
</div>

<script>
(function(){
  var cfg = window.ILLUMINA_CONFIG || null;
  var manifestUrl = cfg ? (typeof cfg.routes?.manifest==="function" ? cfg.routes.manifest(cfg.activeIllumina) : "/data/illumina/1/manifest.json") : "/data/illumina/1/manifest.json";
  var baseAnchors = cfg ? (cfg.routes?.anchors || "/data/anchors") : "/data/anchors";
  var pollenUrl = cfg ? (cfg.routes?.pollen || "/pollen/index.json") : "/pollen/index.json";

  var fallback3in1 = "/Illumina1_Playlist_MASTER_3in1.json"; /* legacy fallback (40d) */  /* :contentReference[oaicite:10]{index=10} */

  var dataCache = Object.create(null);
  var meta = {title:"Illumina", start:"", end:"", days:42};
  var lane = "anchor-public"; // default = AnchorPublic
  var playOrder = [];
  var currentIndex = -1;
  var loopMode = false;
  var yt = document.getElementById('yt');
  var playerReady = false, queuedId = "";

  var elCards = document.getElementById('cards');
  var elCycle = document.getElementById('cycle');
  var elSearch = document.getElementById('search');
  var elDayJump = document.getElementById('dayJump');
  var elLaneSel = document.getElementById('lane');
  var elNowTitle = document.getElementById('nowTitle');
  var elNowMeta = document.getElementById('nowMeta');
  var prevBtn = document.getElementById('prevBtn');
  var nextBtn = document.getElementById('nextBtn');
  var loopToggle = document.getElementById('loopToggle');
  var minBtn = document.getElementById('minBtn');
  var fillBtn = document.getElementById('fillBtn');
  var fsBtn = document.getElementById('fsBtn');

  function safe(v){ return v==null ? "" : String(v); }
  function extractYouTubeID(u){ if(!u) return ""; var s=String(u); var m=s.match(/[?&]v=([^&]+)/)||s.match(/youtu\.be\/([^?&]+)/)||s.match(/embed\/([^?&]+)/); return m?m[1]:""; }
  function hasYT(u){ return !!extractYouTubeID(u); }

  function jarHref(dateStr){ return "https://jar.plnt.earth/day/?date="+encodeURIComponent(dateStr||""); } /* :contentReference[oaicite:11]{index=11} */

  function buildOrder(items){
    playOrder = [];
    for(var i=0;i<items.length;i++){
      var it = items[i];
      if(it && it.urls && it.urls.youtube && hasYT(it.urls.youtube)){ playOrder.push(it.day); }
    }
  }

  function updateNow(item){
    var t = safe(item.title);
    elNowTitle.textContent = t;
    elNowMeta.textContent = (item.date||"")+" · "+(item.moonPhase||"");
  }

  function playByDay(day){
    var items = dataCache[lane]?.items || [];
    var item = items.find(function(x){ return +x.day===+day; });
    if(!item) return;
    var id = extractYouTubeID(item.urls && item.urls.youtube);
    updateNow(item);
    currentIndex = playOrder.indexOf(day);
    if(id){
      yt.src = "https://www.youtube.com/embed/"+id+"?autoplay=1&rel=0&modestbranding=1&playsinline=1";
    }else{
      yt.src = "about:blank";
    }
    // Scroll to card
    var el = document.getElementById('day-'+day);
    if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
  }

  function playNext(){
    if(playOrder.length===0){ return; }
    if(currentIndex < 0){ currentIndex = 0; }
    else { currentIndex = (currentIndex + 1) % playOrder.length; } // wrap to Day 1 after last
    playByDay(playOrder[currentIndex]);
  }
  function playPrev(){
    if(playOrder.length===0){ return; }
    currentIndex = (currentIndex <= 0) ? (playOrder.length - 1) : (currentIndex - 1);
    playByDay(playOrder[currentIndex]);
  }

  function moonGlyph(s){ return (s||"").split(" ")[0]||""; }

  function render(){
    var items = dataCache[lane]?.items || [];
    var rows = [];
    var term = (elSearch.value||"").toLowerCase();

    function show(it){
      if(!term) return true;
      return safe(it.title).toLowerCase().indexOf(term)>-1 || safe(it.seedRitual).toLowerCase().indexOf(term)>-1;
    }

    for(var i=0;i<items.length;i++){
      var it = items[i]; if(!show(it)) continue;
      var d = it.day, date = it.date, yt=it.urls && it.urls.youtube, has=hasYT(yt);
      rows.push(
        '<article class="card" id="day-'+d+'">'+
          '<div class="row">'+
            '<span class="tag">Day '+d+'</span>'+
            '<span class="tag mono">'+date+'</span>'+
            '<span class="tag">'+lane.replace("-","")+'</span>'+
            '<span class="tag">'+moonGlyph(it.moonPhase)+'</span>'+
            '<button class="navbtn" type="button" data-play="'+d+'">Play</button>'+
            '<a class="navbtn" href="'+jarHref(date)+'" target="_blank" rel="noopener">Jar Day</a>'+
            '<button class="navbtn" type="button" data-share="'+d+'">Share</button>'+
          '</div>'+
          '<div class="meta">'+
            '<div class="title">'+safe(it.title)+'</div>'+
            (it.figure?'<div class="muted">Figure: '+safe(it.figure)+'</div>':'')+
            (it.seedRitual?'<div class="muted">Seed: '+safe(it.seedRitual)+'</div>':'')+
            '<div class="platforms">'+
              (has?'<span class="badge ok">YouTube ready</span>':'<span class="badge err">YouTube link missing</span>')+
              (it.urls && it.urls.appleMusic ? '<a class="play" href="'+it.urls.appleMusic+'" target="_blank" rel="noopener"> Apple Music</a>' : '')+
              (it.urls && it.urls.spotify ? '<a class="play" href="'+it.urls.spotify+'" target="_blank" rel="noopener">Spotify</a>' : '')+
            '</div>'+
          '</div>'+
        '</article>'
      );
    }
    elCards.innerHTML = rows.join('');
    // cycle badge
    elCycle.textContent = 'Cycle: '+(meta.start||'2025-11-05')+' → '+(meta.end||'2025-12-16')+' · Days: '+(items.length||'—');

    buildOrder(items);

    elCards.querySelectorAll('button[data-play]').forEach(function(b){
      b.addEventListener('click', function(){ playByDay(+this.getAttribute('data-play')); });
    });
    elCards.querySelectorAll('button[data-share]').forEach(function(b){
      b.addEventListener('click', function(){
        var d = this.getAttribute('data-share'); var u = new URL(location.href);
        u.searchParams.set('lane', lane); u.searchParams.set('day', d);
        if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(u.toString()); }
        this.textContent='Copied!'; var self=this; setTimeout(function(){ self.textContent='Share'; }, 900);
      });
    });
  }

  function buildDayJump(){
    var items = dataCache[lane]?.items || [];
    var opts = ['<option value="">Jump to day…</option>'];
    for(var i=0;i<items.length;i++){ var d=items[i].day; opts.push('<option value="'+d+'">Day '+d+'</option>'); }
    elDayJump.innerHTML = opts.join('');
  }

  function jumpTo(day){
    var el = document.getElementById('day-'+day);
    if(!el) return; el.scrollIntoView({behavior:'smooth', block:'start'});
  }

  function fetchJSON(u){ return fetch(u,{cache:'no-store'}).then(function(r){ if(!r.ok) throw 0; return r.json(); }); }

  function loadViaManifest(){
    return fetchJSON(manifestUrl).then(function(m){
      // expect schema you supplied in earlier step
      var t = {}; (m.tracks||[]).forEach(function(x){ t[x.id]= ("/data/illumina/"+m.illumina+"/"+x.path); });
      meta.start = m.dates?.start || "2025-11-05"; meta.end = m.dates?.end || "2025-12-16"; meta.days = m.dates?.days || 42;
      return t;
    });
  }

  function ensureLaneLoaded(tracksMap, key){
    if(dataCache[key]) return Promise.resolve();
    var path = tracksMap[key]; if(!path) return Promise.reject();
    return fetchJSON(path).then(function(d){ dataCache[key]=d; });
  }

  function loadAll(){
    return loadViaManifest().then(function(tracksMap){
      // default to AnchorPublic view
      elLaneSel.value = lane;
      return ensureLaneLoaded(tracksMap, lane).then(function(){
        // optional: preload others silently
        var rest = ["explainer","anchor-built"].filter(function(k){ return tracksMap[k]; });
        rest.forEach(function(k){ ensureLaneLoaded(tracksMap, k).catch(function(){}); });
        render(); buildDayJump();
        var qs = new URLSearchParams(location.search);
        var startDay = parseInt(qs.get('day')||"",10);
        if(startDay) playByDay(startDay);
      });
    }).catch(function(){
      // legacy fallback (3-in-1 master)  :contentReference[oaicite:12]{index=12}
      return fetchJSON(fallback3in1).then(function(M){
        var days = M.PerDay || []; meta.start=M.Cycle?.Start||"", meta.end=M.Cycle?.End||"", meta.days=days.length||40;
        // adapt master into our simple lane format
        function toItems(key){ var items=[]; for(var i=0;i<days.length;i++){ var d=days[i]; var row=(d[key]||{}); var url=(row.Platforms&&row.Platforms.YouTube&&row.Platforms.YouTube.url)||null; items.push({day:d.Day,date:d.Date,moonPhase:(d.MoonPhase||""),title:(row.artist?row.artist+" — ":"")+(row.title||""),figure:(d.Figure||""),seedRitual:(d.SeedRitual||""),urls:{youtube:url,appleMusic:null,spotify:null},notes:""});} return items; }
        dataCache["explainer"] = {illumina:1,trackId:"explainer",label:"Explainer",version:"1.0.0",items:toItems("Explainer")};
        dataCache["anchor-public"] = {illumina:1,trackId:"anchor-public",label:"AnchorPublic",version:"1.0.0",items:toItems("AnchorPublic")};
        dataCache["anchor-built"] = {illumina:1,trackId:"anchor-built",label:"AnchorBuilt",version:"1.0.0",items:toItems("AnchorBuilt")};
        render(); buildDayJump();
      }).catch(function(){ elCards.innerHTML=""; elCycle.textContent="Load error";});
    });
  }

  // controls
  elSearch.addEventListener('input', render);
  elDayJump.addEventListener('change', function(){ if(this.value) jumpTo(this.value); });
  elLaneSel.addEventListener('change', function(){ lane=this.value; render(); buildDayJump(); });
  prevBtn.addEventListener('click', playPrev);
  nextBtn.addEventListener('click', playNext);
  window.addEventListener('keydown', function(e){ if(e.altKey && e.key==='ArrowLeft') playPrev(); if(e.altKey && e.key==='ArrowRight') playNext(); });

  try{ loopMode = localStorage.getItem('tunes.loop')==='1'; }catch(e){}
  loopToggle.checked = loopMode;
  loopToggle.addEventListener('change', function(){ loopMode=!!this.checked; try{ localStorage.setItem('tunes.loop', loopMode?'1':'0'); }catch(e){} });

  // video view modes
  var frame = document.querySelector('.frame');
  minBtn.addEventListener('click', function(){ frame.classList.toggle('collapsed'); });
  fillBtn.addEventListener('click', function(){ frame.classList.toggle('tall'); });
  fsBtn.addEventListener('click', function(){
    var el = frame; if(!document.fullscreenElement){ if(el.requestFullscreen) el.requestFullscreen(); }
    else{ if(document.exitFullscreen) document.exitFullscreen(); }
  });

  // rotation sizing helper
  function sync(){ /* sticky header auto-sizes from DOM; no extra work */ }
  window.addEventListener('resize', sync, {passive:true});
  window.addEventListener('orientationchange', sync, {passive:true});

  loadAll();
})();
</script>
</body>
</html>
