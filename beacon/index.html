<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Beacon ‚Äî œÑ Handshake & Test Bench</title>
  <meta name="theme-color" content="#0B0F19">
  <meta name="description" content="Prime-length preambles (31/47), control header bits, and descriptor payload builder for Illumina rendezvous.">
  <style>
    :root{
      --bg:#0B0F19; --ink:#E6EAF2; --muted:#94A3B8; --line:rgba(255,255,255,.12);
      --card:#0F1524; --accent:#A4E8FF; --ok:#34D399; --warn:#FBBF24; --err:#F87171;
      --amber:#F59E0B; --honey:#F7C948; --r:14px; --pad:16px; --maxw:1100px;
    }
    /* Honey / Neon / Jupiter themes to match Tunes */
    body.theme-honey{ --bg:#0C0A09; --ink:#F8FAFC; --muted:#D6D3D1; --line:rgba(245,158,11,.18); --accent:#F5D142; }
    body.theme-neon{  --bg:#080A12; --ink:#EAF2FF; --muted:#9CA3AF; --line:rgba(58,199,255,.25); --accent:#39FF14; }
    body.theme-jupiter{ --bg:#0B0F19; --ink:#EAECEF; --muted:#AAB2C0; --line:rgba(236,120,56,.22); --accent:#EC7838; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);
      font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}

    a{color:#BBD7FF;text-decoration:none}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:clamp(14px,3.5vw,28px)}
    header{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px}
    h1{margin:0;font-size:clamp(22px,4.5vw,34px);letter-spacing:.2px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);
         border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%), var(--card);
         color:var(--ink);font-weight:700;cursor:pointer}
    .btn:hover{border-color:rgba(164,232,255,.35);box-shadow:0 12px 30px rgba(0,0,0,.3)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    select,input[type="number"],input[type="text"]{background:var(--card);border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){ .two{grid-template-columns:1fr 1fr} }
    .card{border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%), var(--card);padding:14px}
    .card h2{margin:2px 0 8px 0;font-size:18px}
    .card h3{margin:10px 0 6px 0;font-size:15px;color:#CFE7FF}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;color:#C9D2E3;word-break:break-all}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center}
    .badge{font-size:12px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
    .ok{color:var(--ok);border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.12)}
    .warn{color:#FBBF24;border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.12)}
    .err{color:var(--err);border-color:rgba(248,113,113,.35);background:rgba(248,113,113,.12)}
    hr{border:none;border-top:1px solid var(--line);margin:14px 0}
    .copy{margin-left:auto}
    .small{font-size:12px;color:var(--muted)}
    .hl{color:#BBD7FF}
    .footer{margin-top:18px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}

    .stack{display:flex;flex-direction:column;gap:10px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;background:rgba(255,255,255,.02)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Beacon ‚Äî œÑ Handshake & Test Bench</h1>
        <div class="muted">Prime preambles (31/47) ¬∑ Golay header (24,12,8) ¬∑ RS(31,19) descriptor ¬∑ Day 31 ‚Üî Day 5 bridge</div>
      </div>
      <div class="row">
        <a class="btn" href="https://tunes.plnt.earth" target="_blank" rel="noopener">üé∂ Back to Tunes</a>
        <a class="btn" href="https://jar.plnt.earth/day/" target="_blank" rel="noopener">üçØ Jar Day</a>
        <a class="btn" href="https://illumina.plnt.earth/%CF%84" target="_blank" rel="noopener">œÑ Spec</a>
        <label class="pill">Theme
          <select id="themeSel">
            <option value="">Default</option>
            <option value="honey">Honey</option>
            <option value="neon">Neon</option>
            <option value="jupiter">Jupiter</option>
          </select>
        </label>
      </div>
    </header>

    <section class="card">
      <h2>1) Convergent Rendezvous (quick view)</h2>
      <div class="chips">
        <span class="chip">Prime preambles: <b class="hl">31</b>, <b class="hl">47</b></span>
        <span class="chip">Low sidelobes (m‚Äëseq, Legendre)</span>
        <span class="chip">Control: Golay <b class="hl">(24,12,8)</b></span>
        <span class="chip">Payload: RS <b class="hl">(31,19)</b> over GF(32)</span>
        <span class="chip">Dimensionless anchors: Œ±, Œº = m‚Çö/m‚Çë, Q, Œ±<sub>G</sub></span>
        <span class="chip">31 ‚Üí 47 = Day 31 ‚Üî next cycle Day 5</span>
      </div>
    </section>

    <section class="grid two">
      <div class="card">
        <h2>2) Preamble Builder (31 / 47)</h2>
        <div class="kv"><div>Length</div>
          <div>
            <label><input type="radio" name="plen" value="31" checked> 31 (in‚Äëcycle)</label>
            &nbsp;&nbsp;
            <label><input type="radio" name="plen" value="47"> 47 (cross‚Äëcycle)</label>
          </div>
        </div>
        <div class="kv"><div>Sequence</div>
          <div>
            <select id="ptype">
              <option value="auto">Auto (good default)</option>
              <option value="mseq">m‚Äësequence (LFSR)</option>
              <option value="legendre">Legendre (+/‚àí residues)</option>
            </select>
          </div>
        </div>
        <div class="kv"><div>Symbols</div>
          <div>
            <label><input type="radio" name="sym" value="01" checked> 0/1</label>
            &nbsp;&nbsp;
            <label><input type="radio" name="sym" value="pm"> ¬±1</label>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="genPre" class="btn">Generate</button>
          <span id="preStats" class="pill">‚Äî</span>
          <button id="copyPre" class="btn copy">Copy bits</button>
        </div>
        <hr>
        <div class="mono" id="preOut">‚Äî</div>
        <div class="small">31 uses 5‚Äëbit LFSR (poly x‚Åµ + x¬≤ + 1). 47 uses Legendre sequence over ‚Ñ§‚ÇÑ‚Çá (n=0..46), with s(0)=0, residues ‚Üí 1, non‚Äëresidues ‚Üí 0 (or ¬±1).</div>
      </div>

      <div class="card">
        <h2>3) Control Header (12 bits ‚Üí Golay 24)</h2>
        <div class="kv"><div>Version (v)</div><div><input id="v" type="number" min="0" max="7" value="1"> <span class="small">3 bits</span></div></div>
        <div class="kv"><div>Topology echo</div><div><select id="topo"><option value="0">0 (off)</option><option value="1">1 (on)</option></select> <span class="small">1 bit</span></div></div>
        <div class="kv"><div>Template ID</div><div><input id="mc" type="number" min="0" max="63" value="0"> <span class="small">6 bits</span></div></div>
        <div class="kv"><div>Lane</div>
          <div>
            <select id="lane">
              <option value="0">0 ¬∑ Explainer</option>
              <option value="1">1 ¬∑ AnchorPublic</option>
              <option value="2">2 ¬∑ AnchorBuilt</option>
            </select>
            <span class="small">2 bits</span>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="pack12" class="btn">Pack 12‚Äëbit</button>
          <span id="hstat" class="pill">‚Äî</span>
          <button id="copy12" class="btn copy">Copy 12‚Äëbit</button>
        </div>
        <hr>
        <div class="mono" id="hbits">‚Äî</div>
        <div class="small">Encoding with Golay(24,12,8) happens after packing. (This page outputs the 12 data bits; you can feed them to a Golay encoder.)</div>
      </div>
    </section>

    <section class="card">
      <h2>4) Descriptor Payload (‚Üí RS(31,19) data)</h2>
      <div class="kv"><div>Day</div><div><input id="day" type="number" min="1" max="42" value="31"> <span class="small">6 bits</span></div></div>
      <div class="kv"><div>Cross‚Äëcycle offset</div><div><input id="xo" type="number" min="-21" max="21" value="16"> <span class="small">6 bits (e.g., +16 for 31‚Üí47)</span></div></div>
      <div class="kv"><div>Anchor A ID</div><div><input id="a1" type="number" min="0" max="127" value="5"> <span class="small">7 bits</span></div></div>
      <div class="kv"><div>Anchor B ID</div><div><input id="a2" type="number" min="0" max="127" value="17"> <span class="small">7 bits</span></div></div>
      <div class="kv"><div>Seed token</div><div><input id="seedTok" type="number" min="0" max="255" value="42"> <span class="small">8 bits</span></div></div>
      <div class="kv"><div>Spare</div><div><input id="spare" type="number" min="0" max="255" value="0"> <span class="small">8 bits (free)</span></div></div>
      <div class="row"><span class="pill">CRC‚Äë16 (CCITT) computed over the above fields</span></div>
      <div class="row" style="margin-top:8px">
        <button id="buildDesc" class="btn">Build payload bits</button>
        <span id="dstat" class="pill">‚Äî</span>
        <button id="copyDesc" class="btn copy">Copy (bits + CRC)</button>
      </div>
      <hr>
      <div class="mono" id="dbits">‚Äî</div>
      <div class="small">The result is a ~95‚Äëbit data block + 16‚Äëbit CRC. Feed into RS(31,19) as 19 five‚Äëbit symbols (pad as needed). RS parity (12 symbols) is added by the encoder.</div>
    </section>

    <section class="grid two">
      <div class="card">
        <h2>5) Assemble (pre‚ÄëECC)</h2>
        <p class="small">Concatenate: <b>Preamble</b> ‚Ä¢ <b>Golay‚Äëcoded Header (24 bits)</b> ‚Ä¢ <b>RS(31,19) codeword (31√ó5‚Äëbit symbols)</b>. Below is a convenience glue of <i>preamble + raw header + raw payload</i> so you can inspect bit budgets before encoding.</p>
        <div class="row">
          <button id="assemble" class="btn">Assemble</button>
          <span id="astat" class="pill">‚Äî</span>
          <button id="copyAsm" class="btn copy">Copy pre‚ÄëECC</button>
        </div>
        <hr>
        <div class="mono" id="asmOut">‚Äî</div>
      </div>

      <div class="card">
        <h2>6) Where to test it</h2>
        <p class="muted">Use these surfaces to plant & detect your 31/47 handshakes under real playback:</p>
        <ul class="small">
          <li>Tunes player (fixed header, auto‚Äënext): <a href="https://tunes.plnt.earth" target="_blank" rel="noopener">tunes.plnt.earth</a></li>
          <li>Jar Day (sticky player, per‚Äëday tasks): <a href="https://jar.plnt.earth/day/" target="_blank" rel="noopener">jar.plnt.earth/day</a></li>
          <li>Constellation Map (context & links): <a href="https://jar.plnt.earth/map/" target="_blank" rel="noopener">jar.plnt.earth/map</a></li>
        </ul>
        <div class="chips">
          <span class="chip">Tip: loop Day 31 in Jar</span>
          <span class="chip">Tip: use 47 preamble to flag Day 5 bridge</span>
          <span class="chip">Tip: keep plant < 5œÉ for detectability tests</span>
        </div>
      </div>
    </section>

    <div class="footer">
      <div>¬© <span id="yy"></span> PLNT.earth ‚Äî Beacon</div>
      <div><span class="small">This page outputs raw bits; ECC encoding happens downstream.</span></div>
    </div>
  </div>

  <script>
    // Year
    document.getElementById('yy').textContent = new Date().getFullYear();

    // Theme (persist like Tunes)
    (function(){
      try{
        var sel = document.getElementById('themeSel');
        var saved = localStorage.getItem('beacon.theme') || '';
        if(saved){ document.body.classList.add('theme-'+saved); sel.value = saved; }
        sel.addEventListener('change', function(){
          document.body.classList.remove('theme-honey','theme-neon','theme-jupiter');
          if(this.value) document.body.classList.add('theme-'+this.value);
          localStorage.setItem('beacon.theme', this.value||'');
        });
      }catch(e){}
    })();

    // Helpers
    function bitstrToArray(s){ return (s||'').trim().split('').map(function(c){return c==='1'?1:0;}); }
    function toBits(val, width){
      var n = Math.max(0, width|0), v = Math.max(0, val|0);
      var out = Array(n).fill(0);
      for(var i=0;i<n;i++){ var b = (v>>>(n-1-i)) & 1; out[i]=b; }
      return out;
    }
    function bitsToHex(bits){
      var s = bits.join('');
      var pad = (4 - (s.length % 4)) % 4;
      s = (pad? '0'.repeat(pad):'') + s;
      var out = [];
      for(var i=0;i<s.length;i+=4){
        out.push(parseInt(s.slice(i,i+4),2).toString(16).toUpperCase());
      }
      return out.join('');
    }
    function bitsToString(bits, mode){
      if(mode==='pm'){ return bits.map(function(b){ return b?'+1':'-1'; }).join(' '); }
      return bits.join('');
    }
    function copyText(text){
      try{ navigator.clipboard.writeText(text); }catch(e){}
    }

    // 2) Preamble Builder
    function lfsr_mseq_31(){
      // Maximal length LFSR for 5-bit: polynomial x^5 + x^2 + 1 (taps at 5 and 2)
      var state = 0b11111; // nonzero seed
      var seq = [];
      for(var i=0;i<31;i++){
        var out = state & 1; // take LSB
        seq.push(out);
        var fb = ((state>>0) ^ (state>>3)) & 1; // taps at bit0 and bit3 (1 and 4) because of LSB orientation
        state = (state>>>1) | (fb<<4);
      }
      // LFSR above emits LSB-first; rotate to common MSB-first if desired ‚Äî here we keep as generated.
      return seq;
    }
    function legendre_mod_p(p){
      // Produce sequence s[0..p-1]: s0=0, residues=1, nonresidues=0
      var residues = new Set();
      for(var x=1;x<p;x++){ residues.add((x*x)%p); }
      var seq = [];
      for(var n=0;n<p;n++){
        if(n===0){ seq.push(0); continue; }
        seq.push(residues.has(n)?1:0);
      }
      return seq;
    }
    function genPreamble(){
      var plen = +document.querySelector('input[name="plen"]:checked').value;
      var ptype = document.getElementById('ptype').value;
      var sym = document.querySelector('input[name="sym"]:checked').value;
      var bits;
      if(plen===31){
        if(ptype==='legendre'){ bits = legendre_mod_p(31); }
        else { bits = lfsr_mseq_31(); }
      }else{ // 47
        if(ptype==='mseq'){ bits = legendre_mod_p(47); } // no 47-length m-seq; fall back to Legendre
        else { bits = legendre_mod_p(47); }
      }
      // Stats
      var ones = bits.reduce(function(a,b){return a+(b?1:0);},0);
      var zeros = bits.length - ones;
      var stats = 'len '+bits.length+' ¬∑ 1s '+ones+' ¬∑ 0s '+zeros;
      document.getElementById('preStats').textContent = stats;
      // Render
      document.getElementById('preOut').textContent = bitsToString(bits, sym);
      // Attach to button
      document.getElementById('copyPre').onclick = function(){ copyText(document.getElementById('preOut').textContent); };
      return bits;
    }
    document.getElementById('genPre').addEventListener('click', genPreamble);
    var lastPre = genPreamble();

    // 3) Control Header pack (12 bits: v3, topo1, mc6, lane2)
    function packHeader12(){
      var v = (+document.getElementById('v').value)|0;
      var topo = (+document.getElementById('topo').value)|0;
      var mc = (+document.getElementById('mc').value)|0;
      var lane = (+document.getElementById('lane').value)|0;
      // Bounds
      v = Math.min(7, Math.max(0,v));
      topo = topo?1:0;
      mc = Math.min(63, Math.max(0,mc));
      lane = Math.min(3, Math.max(0,lane));
      // Layout: [v(3) | topo(1) | mc(6) | lane(2)]
      var bits = []
        .concat(toBits(v,3))
        .concat(toBits(topo,1))
        .concat(toBits(mc,6))
        .concat(toBits(lane,2));
      var hex = bitsToHex(bits);
      document.getElementById('hbits').textContent = 'bits: '+bits.join('')+'  ¬∑ hex: 0x'+hex;
      document.getElementById('hstat').textContent = '12 bits ready';
      document.getElementById('copy12').onclick = function(){ copyText(bits.join('')); };
      return bits;
    }
    document.getElementById('pack12').addEventListener('click', packHeader12);
    var lastHdr = packHeader12();

    // CRC-16/CCITT (0x1021), init 0xFFFF, no reflection, no xorout
    function crc16_ccitt_bits(bits){
      var crc = 0xFFFF;
      for(var i=0;i<bits.length;i++){
        var bit = bits[i] & 1;
        var c15 = ((crc >> 15) & 1);
        crc = ((crc << 1) & 0xFFFF) | 0;
        if (c15 ^ bit) { crc ^= 0x1021; }
      }
      return crc & 0xFFFF;
    }

    // 4) Build descriptor (~95 bits + CRC-16) ‚Äî field pack
    function buildDescriptor(){
      var day = (+document.getElementById('day').value)|0;
      var xo  = (+document.getElementById('xo').value)|0;
      var a1  = (+document.getElementById('a1').value)|0;
      var a2  = (+document.getElementById('a2').value)|0;
      var seed= (+document.getElementById('seedTok').value)|0;
      var spr = (+document.getElementById('spare').value)|0;
      // Clamp
      day=Math.min(42,Math.max(1,day));
      xo = Math.min(21,Math.max(-21,xo));
      // map xo signed to unsigned 6-bit (bias 32 or 31). Use bias 32 for [-32..31]; but our range is ¬±21, pick bias 32 to avoid negatives
      var xo_u = xo & 0x3F; // two's complement 6-bit
      a1 = Math.min(127,Math.max(0,a1));
      a2 = Math.min(127,Math.max(0,a2));
      seed = Math.min(255,Math.max(0,seed));
      spr = Math.min(255,Math.max(0,spr));

      var bits = []
        .concat(toBits(day,6))
        .concat(toBits(xo_u,6))
        .concat(toBits(a1,7))
        .concat(toBits(a2,7))
        .concat(toBits(seed,8))
        .concat(toBits(spr,8));
      // At this point we have 42 bits. Add padding fields to approach ~95 data bits if needed.
      // Provide a small placeholder "Flags" (8) and "Tuple index" (16) and "Reserved" (15) as example:
      var flags = 0;       // 8
      var tuple = 0;       // 16 (e.g., index into (Œ±, Œº, Q, Œ±_G) symbol table)
      var reserved = 0;    // 15
      bits = bits
        .concat(toBits(flags,8))
        .concat(toBits(tuple,16))
        .concat(toBits(reserved,15));
      // Now bits length = 42 + 8 + 16 + 15 = 81
      // Add CRC-16 over the 81 bits:
      var crc = crc16_ccitt_bits(bits);
      var crcBits = toBits(crc,16);
      var all = bits.concat(crcBits);
      document.getElementById('dbits').textContent = 'bits('+all.length+'): '+all.join('')+'  ¬∑ CRC16=0x'+crc.toString(16).toUpperCase().padStart(4,'0');
      document.getElementById('dstat').textContent = all.length+' bits ready';
      document.getElementById('copyDesc').onclick = function(){ copyText(all.join('')); };
      return all;
    }
    document.getElementById('buildDesc').addEventListener('click', buildDescriptor);
    var lastDesc = buildDescriptor();

    // 5) Assemble (pre-ECC)
    function assemble(){
      var preText = document.getElementById('preOut').textContent.trim();
      var mode = document.querySelector('input[name="sym"]:checked').value;
      var preBits = [];
      if(mode==='pm'){
        preBits = preText.split(/\s+/).map(function(x){ return (x==='+1')?1:0; });
      }else{
        preBits = preText.split('').map(function(c){ return c==='1'?1:0; });
      }
      var hdrBits = bitstrToArray((document.getElementById('hbits').textContent.match(/bits:\s*([01]+)/)||['',''])[1]);
      var descBits = bitstrToArray((document.getElementById('dbits').textContent.match(/bits\(\d+\):\s*([01]+)/)||['',''])[1]);
      var out = preBits.concat(hdrBits).concat(descBits);
      document.getElementById('asmOut').textContent = 'bits('+out.length+'): '+out.join('');
      document.getElementById('astat').textContent = out.length+' bits (pre‚ÄëECC)';
      document.getElementById('copyAsm').onclick = function(){ copyText(out.join('')); };
      return out;
    }
    document.getElementById('assemble').addEventListener('click', assemble);
  </script>
</body>
</html>
