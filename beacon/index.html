<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Beacon · Illumina 31/47</title>
<meta name="theme-color" content="#0B0F19">
<meta name="description" content="Illumina beacon: 31/47 prime headers as audio beacons, MIDI clips, and printable jar-lid SVG rings.">
<style>
  :root{--bg:#0B0F19;--ink:#E5E7EB;--muted:#9CA3AF;--line:rgba(229,231,235,.15);--amber:#F59E0B;--maxw:1100px;--r:14px}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:#F5D142;text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:clamp(14px,3.5vw,28px)}
  header{display:grid;gap:10px;margin:4px 0 18px}
  h1{margin:0;font-size:clamp(22px,4.5vw,34px);line-height:1.2}
  .muted{color:var(--muted)}
  .nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:#cfd3db;font-size:13px}
  .btn{border:1px solid var(--line);border-radius:12px;padding:10px 14px;background:rgba(255,255,255,.02);color:var(--ink);cursor:pointer}
  .btn.primary{border-color:var(--amber);background:linear-gradient(180deg,rgba(245,158,11,.18),rgba(245,158,11,.1))}
  input[type="number"],input[type="text"]{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.02);color:var(--ink);font:inherit}
  label{font-size:13px;color:var(--muted)}
  .grid{display:grid;gap:14px;grid-template-columns:1fr} @media(min-width:900px){.grid{grid-template-columns:1.05fr .95fr}}
  .card{border:1px solid var(--line);border-radius:var(--r);padding:18px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0))}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px}
  .cols{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
  .cols2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  #ringPreview{background:#0f1118;border:1px dashed var(--line);border-radius:12px;display:flex;align-items:center;justify-content:center;padding:8px}
  footer{margin:18px 0 4px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="nav">
      <span class="pill">Beacon</span>
      <a class="pill" href="https://tunes.plnt.earth">Tunes</a>
      <a class="pill" href="https://jar.plnt.earth">Jar</a>
      <a class="pill" href="https://honey.plnt.earth">Honey</a>
    </div>
    <h1>Illumina Beacon — 31/47</h1>
    <p class="muted">Play the prime headers as audio beacons, export DAW‑ready MIDI, and generate a printable jar‑lid ring. L31 pairs with Illumina‑1 · Day 31; L47 answers on Illumina‑2 · Day 5.</p>
  </header>

  <section class="grid">
    <article class="card" aria-labelledby="audioTitle">
      <h2 id="audioTitle" style="margin:0 0 8px;font-size:18px">Beacon Player & MIDI</h2>
      <div class="row">
        <label><input type="radio" name="pat" value="31" checked> L31</label>
        <label><input type="radio" name="pat" value="47"> L47</label>
        <label for="tempo">Tempo</label>
        <input id="tempo" type="number" step="0.001" value="93.000" min="40" max="240" aria-label="Tempo (BPM)">
        <label for="loops">Loops</label>
        <input id="loops" type="number" value="2" min="1" max="16" aria-label="Number of loops">
        <label><input id="primeGap" type="checkbox"> Prime‑gap spacing</label>
        <button id="play" class="btn primary" type="button">Play</button>
        <button id="stop" class="btn" type="button">Stop</button>
        <button id="dlMidi" class="btn" type="button">Download MIDI</button>
      </div>
      <div class="cols2" style="margin-top:10px">
        <div>
          <div class="row"><label>1‑positions (1‑based)</label></div>
          <div id="ones" class="mono"></div>
          <div class="row" style="margin-top:8px"><label>Bitstring</label></div>
          <div id="bits" class="mono"></div>
        </div>
        <div>
          <div class="row"><span class="pill">Tip</span><span class="muted">L31 at 93 BPM = 5.000 s · L47 at 94 BPM = 7.5 s</span></div>
        </div>
      </div>
    </article>

    <article class="card" aria-labelledby="ringTitle">
      <h2 id="ringTitle" style="margin:0 0 8px;font-size:18px">Jar‑Lid Ring (SVG)</h2>
      <div class="cols">
        <div class="row">
          <label for="centerTitle">Center</label>
          <input id="centerTitle" type="text" value="Illumina 1/7">
        </div>
        <div class="row">
          <label for="centerSub">Subtitle</label>
          <input id="centerSub" type="text" value="L31 header (31 ticks)">
        </div>
        <div class="row">
          <label for="diameter">Diameter (mm)</label>
          <input id="diameter" type="number" value="80" min="30" max="200">
        </div>
      </div>
      <div class="cols2" style="margin-top:8px">
        <div class="row">
          <label for="batchKey">Batch key</label>
          <input id="batchKey" type="text" placeholder="Y | D | J | Io">
        </div>
        <div class="row" style="justify-content:flex-end">
          <button id="dlSvg" class="btn" type="button">Download SVG</button>
        </div>
      </div>
      <div id="ringPreview" style="margin-top:8px"></div>
    </article>
  </section>

  <footer>
    <p>PLNT Earth · Beacon</p>
  </footer>
</div>

<script>
  function mp(b,e,m){var r=1%m,x=b%m,n=e|0;while(n>0){if(n&1)r=(r*x)%m;x=(x*x)%m;n>>=1}return r}
  function legSeq(p){var a=new Array(p).fill(0);for(var n=1;n<p;n++)a[n]=mp(n,(p-1)/2,p)===1?1:0;return a}
  var seq31=legSeq(31), seq47=legSeq(47);

  var tempo=document.getElementById('tempo'), loops=document.getElementById('loops'), primeGap=document.getElementById('primeGap');
  var bits=document.getElementById('bits'), ones=document.getElementById('ones');
  var centerTitle=document.getElementById('centerTitle'), centerSub=document.getElementById('centerSub'), diameter=document.getElementById('diameter'), batchKey=document.getElementById('batchKey'), ringPreview=document.getElementById('ringPreview');

  function curSeq(){var v=document.querySelector('input[name="pat"]:checked').value;return v==='31'?seq31:seq47}
  function setDefaults(){var v=document.querySelector('input[name="pat"]:checked').value;if(v==='31'){if(document.activeElement!==tempo)tempo.value='93.000';centerTitle.value='Illumina 1/7';centerSub.value='L31 header (31 ticks)'}else{if(document.activeElement!==tempo)tempo.value='94.000';centerTitle.value='Illumina 2/7';centerSub.value='L47 header (47 ticks)'} renderInfo(); renderRing()}
  function onesPos(s){var out=[];for(var i=0;i<s.length;i++)if(s[i]===1)out.push(i+1);return out}
  function renderInfo(){var s=curSeq();bits.textContent=s.join(' ');ones.textContent=onesPos(s).join(', ')}

  function esc(x){return String(x).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
  function ringSVG(seq, center, sub, diaMM, key){
    var p=seq.length,cx=500,cy=500,rO=430,rI=320,ticks='';
    for(var i=0;i<p;i++){var a=(-90+360*i/p)*Math.PI/180,len=seq[i]===1?70:40,x0=cx+rO*Math.cos(a),y0=cy+rO*Math.sin(a),x1=cx+(rO-len)*Math.cos(a),y1=cy+(rO-len)*Math.sin(a);ticks+='<line x1="'+x0.toFixed(2)+'" y1="'+y0.toFixed(2)+'" x2="'+x1.toFixed(2)+'" y2="'+y1.toFixed(2)+'" stroke="#000" stroke-width="4" stroke-linecap="butt"/>'}
    var bt=key&&key.trim().length?key:'Batch key:  Y  |  D  |  J  |  Io';
    return '<?xml version="1.0" encoding="UTF-8"?>'
      +'<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="'+diaMM+'mm" height="'+diaMM+'mm" viewBox="0 0 1000 1000">'
      +'<rect x="0" y="0" width="1000" height="1000" fill="#ffffff"/>'
      +'<circle cx="'+cx+'" cy="'+cy+'" r="'+rO+'" fill="none" stroke="#000" stroke-width="2"/>'
      +'<circle cx="'+cx+'" cy="'+cy+'" r="'+rI+'" fill="none" stroke="#000" stroke-width="1"/>'
      +ticks
      +'<text x="'+cx+'" y="'+(cy-10)+'" text-anchor="middle" font-family="Arial, Helvetica, sans-serif" font-size="40" fill="#000">'+esc(center)+'</text>'
      +'<text x="'+cx+'" y="'+(cy+35)+'" text-anchor="middle" font-family="Arial, Helvetica, sans-serif" font-size="24" fill="#000">'+esc(sub)+'</text>'
      +'<text x="'+cx+'" y="'+(cy+200)+'" text-anchor="middle" font-family="Arial, Helvetica, sans-serif" font-size="22" fill="#000">'+esc(bt)+'</text>'
      +'</svg>';
  }
  function renderRing(){var s=curSeq();var svg=ringSVG(s,centerTitle.value,centerSub.value,Number(diameter.value||80),batchKey.value);ringPreview.innerHTML=svg}

  var ctx=null,nodes=[];
  function schedule(at,d){var o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=1000;g.gain.setValueAtTime(0,at);g.gain.linearRampToValueAtTime(0.9,at+0.002);g.gain.exponentialRampToValueAtTime(0.0008,at+d);o.connect(g).connect(ctx.destination);o.start(at);o.stop(at+d+0.01);nodes.push(o);nodes.push(g)}
  function times(seq,bpm,loops,pg){var step=(60/bpm)/4,list=[],t=0,k=0;for(var L=0;L<loops;L++){for(var i=0;i<seq.length;i++)if(seq[i]===1)list.push(t+i*step);t+=seq.length*step;if(pg){var P=[2,3,5,7,11];t+=P[k%P.length];k++}}return list}
  function play(){if(ctx)return;ctx=new (window.AudioContext||window.webkitAudioContext)();var s=curSeq(),bpm=Number(tempo.value||93),L=Math.max(1,Math.min(16,Number(loops.value)||1));var ts=times(s,bpm,L,primeGap.checked),start=ctx.currentTime+0.06,d=(60/bpm)/12;for(var i=0;i<ts.length;i++)schedule(start+ts[i],d)}
  function stop(){if(!ctx)return;try{for(var i=0;i<nodes.length;i++){var n=nodes[i];if(n&&n.stop)n.stop();if(n&&n.disconnect)n.disconnect()}}catch(e){}nodes=[];ctx.close();ctx=null}

  function vlq(n){var a=[n&127];n>>=7;while(n>0){a.unshift((n&127)|128);n>>=7}return new Uint8Array(a)}
  function cat(x){var l=0;for(var i=0;i<x.length;i++)l+=x[i].length;var o=new Uint8Array(l),p=0;for(i=0;i<x.length;i++){o.set(x[i],p);p+=x[i].length}return o}
  function textEv(d,t,s){var b=new TextEncoder().encode(s);return cat([vlq(d),new Uint8Array([255,t,b.length]),b])}
  function tempoEv(d,bpm){var u=Math.round(60000000/bpm);return cat([vlq(d),new Uint8Array([255,81,3,(u>>16)&255,(u>>8)&255,u&255])])}
  function noteOn(d,ch,n,v){return cat([vlq(d),new Uint8Array([144|ch,n,v])])}
  function noteOff(d,ch,n){return cat([vlq(d),new Uint8Array([128|ch,n,0])])}
  function buildMidi(seq,bpm){var ppq=480,ch=9,step=ppq/4,nt=ppq/12,tr=new Uint8Array(0),delta=0;tr=cat([tr,textEv(0,3,'Beacon'),tempoEv(0,bpm)]);for(var i=0;i<seq.length;i++){if(seq[i]===1){tr=cat([tr,noteOn(delta,ch,42,100),noteOff(nt,ch,42)]);delta=step-nt}else{delta+=step}}tr=cat([tr,vlq(delta),new Uint8Array([255,47,0])]);var mthd=cat([new TextEncoder().encode('MThd'),new Uint8Array([0,0,0,6,0,0,0,1,(ppq>>8)&255,ppq&255])]);var len=new Uint8Array([(tr.length>>>24)&255,(tr.length>>>16)&255,(tr.length>>>8)&255,tr.length&255]);var mtrk=cat([new TextEncoder().encode('MTrk'),len,tr]);return cat([mthd,mtrk])}
  function download(bytes,name,type){var blob=new Blob([bytes],{type:type});var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;document.body.appendChild(a);a.click();a.remove();setTimeout(function(){URL.revokeObjectURL(a.href)},2000)}

  document.getElementsByName('pat').forEach(function(r){r.addEventListener('change',setDefaults)});
  tempo.addEventListener('change',renderInfo); loops.addEventListener('change',renderInfo); primeGap.addEventListener('change',renderInfo);
  centerTitle.addEventListener('input',renderRing); centerSub.addEventListener('input',renderRing); diameter.addEventListener('change',renderRing); batchKey.addEventListener('input',renderRing);

  document.getElementById('play').addEventListener('click',play);
  document.getElementById('stop').addEventListener('click',stop);
  document.getElementById('dlMidi').addEventListener('click',function(){var s=curSeq(),b=Number(tempo.value||93);download(buildMidi(s,b),'Beacon_'+(s.length===31?'L31':'L47')+'_'+b.toFixed(3)+'bpm.mid','audio/midi')});
  document.getElementById('dlSvg').addEventListener('click',function(){var s=curSeq(),svg=ringSVG(s,centerTitle.value,centerSub.value,Number(diameter.value||80),batchKey.value);download(new TextEncoder().encode(svg),s.length===31?'Jar_Lid_Ring_31.svg':'Jar_Lid_Ring_47.svg','image/svg+xml')});

  function init(){setDefaults();renderInfo();renderRing()}
  if(document.readyState==='complete'||document.readyState==='interactive')init();else document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
